name: Komoot Squadra Sync & Deploy

on:
  # Synchronisation quotidienne automatique
  schedule:
    - cron: '0 6 * * *'  # Tous les jours √† 6h UTC (7h Paris hiver, 8h √©t√©)
  
  # D√©clenchement manuel depuis GitHub
  workflow_dispatch:
  
  # D√©clenchement au push (optionnel)
  push:
    branches:
      - main
    paths:
      - 'komoot_squadra_improved.py'
      - '.github/workflows/komoot-sync.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ====================================
      # 1. PREPARATION
      # ====================================
      
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # N√©cessaire pour r√©cup√©rer l'historique
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests gpxpy folium
      
      # ====================================
      # 2. RECUPERATION DES DONNEES EXISTANTES
      # ====================================
      
      - name: üì• R√©cup√©rer les donn√©es existantes (all_points.json)
        continue-on-error: true
        run: |
          echo "üîç Recherche de all_points.json dans gh-pages..."
          
          # Essayer de r√©cup√©rer depuis gh-pages
          if git fetch origin gh-pages 2>/dev/null; then
            if git checkout origin/gh-pages -- all_points.json 2>/dev/null; then
              echo "‚úÖ all_points.json r√©cup√©r√© depuis gh-pages"
              ls -lh all_points.json
            else
              echo "‚ö†Ô∏è all_points.json non trouv√© dans gh-pages"
              echo "{\"traces\": [], \"tour_ids\": [], \"last_tours\": [], \"stats\": {\"dist\": 0, \"count\": 0}}" > all_points.json
            fi
          else
            echo "‚ÑπÔ∏è Branche gh-pages inexistante (premi√®re ex√©cution)"
            echo "{\"traces\": [], \"tour_ids\": [], \"last_tours\": [], \"stats\": {\"dist\": 0, \"count\": 0}}" > all_points.json
          fi
          
          # Retour sur main
          git checkout main 2>/dev/null || true
      
      # ====================================
      # 3. SYNCHRONISATION KOMOOT
      # ====================================
      
      - name: üîÑ Synchronisation Komoot
        env:
          KOMOOT_USER_ID: ${{ secrets.KOMOOT_USER_ID }}
          KOMOOT_SESSION_COOKIE: ${{ secrets.KOMOOT_SESSION_COOKIE }}
          GITHUB_REPO_OWNER: ${{ secrets.GITHUB_REPO_OWNER }}
          GITHUB_REPO_NAME: ${{ secrets.GITHUB_REPO_NAME }}
          SIMPLIFY_FACTOR: ${{ vars.SIMPLIFY_FACTOR || '3' }}
          TILE_ZOOM: ${{ vars.TILE_ZOOM || '14' }}
          TRACE_OPACITY: ${{ vars.TRACE_OPACITY || '0.6' }}
          TILE_OPACITY: ${{ vars.TILE_OPACITY || '0.15' }}
          TILE_COLOR: ${{ vars.TILE_COLOR || '#7ED321' }}
          TRACE_COLOR: ${{ vars.TRACE_COLOR || '#D0021B' }}
        run: |
          echo "=========================================="
          echo "üöÄ KOMOOT SQUADRA MAP - SYNCHRONISATION"
          echo "=========================================="
          echo ""
          echo "Configuration:"
          echo "  User ID: ${{ secrets.KOMOOT_USER_ID }}"
          echo "  Simplify Factor: ${SIMPLIFY_FACTOR}"
          echo "  Tile Zoom: ${TILE_ZOOM}"
          echo "  Tile Color: ${TILE_COLOR}"
          echo "  Trace Color: ${TRACE_COLOR}"
          echo ""
          
          python komoot_squadra_improved.py
          
          echo ""
          echo "‚úÖ Synchronisation termin√©e"
      
      # ====================================
      # 4. VERIFICATION
      # ====================================
      
      - name: üìä V√©rification des fichiers g√©n√©r√©s
        run: |
          echo "üîç V√©rification des fichiers..."
          
          if [ ! -f "index.html" ]; then
            echo "‚ùå ERREUR: index.html non g√©n√©r√©"
            exit 1
          fi
          
          if [ ! -f "all_points.json" ]; then
            echo "‚ùå ERREUR: all_points.json non g√©n√©r√©"
            exit 1
          fi
          
          echo "‚úÖ Fichiers v√©rifi√©s:"
          ls -lh index.html all_points.json
          
          # Afficher quelques stats du JSON
          echo ""
          echo "üìä Statistiques:"
          python3 -c "import json; data=json.load(open('all_points.json')); print(f\"  Tours: {data['stats']['count']}\"); print(f\"  Traces: {len(data['traces'])}\")"
      
      # ====================================
      # 5. DEPLOIEMENT GITHUB PAGES
      # ====================================
      
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          commit_message: 'üó∫Ô∏è Update Squadra Map [Run ${{ github.run_number }}]'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          # Inclure seulement les fichiers n√©cessaires
          exclude_assets: '.github,*.py,*.md,requirements.txt'
      
      # ====================================
      # 6. RESUME
      # ====================================
      
      - name: üìù Cr√©ation du r√©sum√©
        if: always()
        run: |
          echo "# üó∫Ô∏è Komoot Squadra Map - Synchronisation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "index.html" ]; then
            echo "## ‚úÖ Synchronisation r√©ussie" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üåê **Votre carte est disponible ici:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üëâ **https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "all_points.json" ]; then
              echo "## üìä Statistiques" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              python3 -c 'import json; data=json.load(open("all_points.json")); print(f"Tours synchronis√©s: {data[\"stats\"][\"count\"]}"); print(f"Traces stock√©es: {len(data[\"traces\"])}"); print(f"Derniers tours: {len(data.get(\"last_tours\", []))}")' >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ùå √âchec de la synchronisation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs ci-dessus pour plus de d√©tails." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üïê **Date:** $(date +'%d/%m/%Y √† %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "üî¢ **Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "‚è∞ Synchronisation automatique quotidienne" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üñ±Ô∏è Synchronisation manuelle" >> $GITHUB_STEP_SUMMARY
          else
            echo "üìù Synchronisation suite √† un push" >> $GITHUB_STEP_SUMMARY
          fi
      
      # ====================================
      # 7. NOTIFICATION (Optionnel)
      # ====================================
      
      - name: üìß Notification (√©chec uniquement)
        if: failure()
        run: |
          echo "‚ö†Ô∏è La synchronisation a √©chou√©"
          echo "V√©rifiez les logs : https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
