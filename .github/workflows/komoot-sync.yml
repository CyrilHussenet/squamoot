name: Komoot Squadra Sync & Deploy

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'komoot_squadra_improved.py'
      - '.github/workflows/komoot-sync.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    # CORRECTION ICI : On passe de 15 √† 60 minutes
    timeout-minutes: 60
    
    steps:
      # 1. PR√âPARATION
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests folium cloudscraper
      
      # 2. R√âCUP√âRATION HISTORIQUE
      - name: üì• R√©cup√©rer les donn√©es existantes
        continue-on-error: true
        run: |
          git fetch origin gh-pages 2>/dev/null || true
          git checkout origin/gh-pages -- all_points.json 2>/dev/null || echo "‚ö†Ô∏è Pas d'historique trouv√©, on part de z√©ro."
      
      # 3. SYNCHRONISATION
      - name: üîÑ Synchronisation Komoot
        env:
          KOMOOT_USER_ID: ${{ secrets.KOMOOT_USER_ID }}
          # Param√®tres visuels
          SIMPLIFY_FACTOR: '2'
          TILE_ZOOM: '14'
        run: |
          echo "üöÄ Lancement du script..."
          python komoot_squadra_improved.py
      
      # 4. PR√âPARATION DU D√âPLOIEMENT
      - name: üì¶ Pr√©parer le dossier propre (public)
        run: |
          echo "üìÇ Cr√©ation du dossier de d√©ploiement..."
          mkdir -p public
          
          if [ -f "index.html" ]; then
            cp index.html public/
            echo "‚úÖ index.html copi√©"
          else
            echo "<h1>Erreur: index.html non g√©n√©r√© par le script Python</h1>" > public/index.html
          fi
          
          if [ -f "all_points.json" ]; then
            cp all_points.json public/
            echo "‚úÖ all_points.json copi√©"
          else
            echo "{}" > public/all_points.json
          fi
          
          touch public/.nojekyll

      # 5. D√âPLOIEMENT
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'KomootBot'
          user_email: 'bot@komoot-map.com'
