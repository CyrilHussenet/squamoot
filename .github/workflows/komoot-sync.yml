name: Komoot Squadra Sync & Deploy

on:
  # Synchronisation quotidienne automatique
  schedule:
    - cron: '0 6 * * *'  # Tous les jours Ã  6h UTC (7h Paris hiver, 8h Ã©tÃ©)
  
  # DÃ©clenchement manuel depuis GitHub
  workflow_dispatch:
  
  # DÃ©clenchement au push (optionnel)
  push:
    branches:
      - main
    paths:
      - 'komoot_squadra_improved.py'
      - '.github/workflows/komoot-sync.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ====================================
      # 1. PREPARATION
      # ====================================
      
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour rÃ©cupÃ©rer l'historique
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          # AJOUT DE CLOUDSCRAPER ICI
          pip install requests folium cloudscraper
      
      # ====================================
      # 2. RECUPERATION DES DONNEES EXISTANTES
      # ====================================
      
      - name: ðŸ“¥ RÃ©cupÃ©rer les donnÃ©es existantes (all_points.json)
        continue-on-error: true
        run: |
          echo "ðŸ” Recherche de all_points.json dans gh-pages..."
          
          # Essayer de rÃ©cupÃ©rer depuis gh-pages
          if git fetch origin gh-pages 2>/dev/null; then
            if git checkout origin/gh-pages -- all_points.json 2>/dev/null; then
              echo "âœ… all_points.json rÃ©cupÃ©rÃ© depuis gh-pages"
              ls -lh all_points.json
            else
              echo "âš ï¸ all_points.json non trouvÃ© dans gh-pages"
              echo "{\"traces\": [], \"tour_ids\": [], \"last_tours\": [], \"stats\": {\"dist\": 0, \"count\": 0}}" > all_points.json
            fi
          else
            echo "â„¹ï¸ Branche gh-pages inexistante (premiÃ¨re exÃ©cution)"
            echo "{\"traces\": [], \"tour_ids\": [], \"last_tours\": [], \"stats\": {\"dist\": 0, \"count\": 0}}" > all_points.json
          fi
          
          # Retour sur main
          git checkout main 2>/dev/null || true
      
      # ====================================
      # 3. SYNCHRONISATION KOMOOT
      # ====================================
      
      - name: ðŸ”„ Synchronisation Komoot
        env:
          KOMOOT_USER_ID: ${{ secrets.KOMOOT_USER_ID }}
          # Le cookie est laissÃ© mais n'est plus critique avec la mÃ©thode publique
          KOMOOT_SESSION_COOKIE: ${{ secrets.KOMOOT_SESSION_COOKIE }}
          GITHUB_REPO_OWNER: ${{ secrets.GITHUB_REPO_OWNER }}
          GITHUB_REPO_NAME: ${{ secrets.GITHUB_REPO_NAME }}
          SIMPLIFY_FACTOR: ${{ vars.SIMPLIFY_FACTOR || '3' }}
          TILE_ZOOM: ${{ vars.TILE_ZOOM || '14' }}
          TRACE_OPACITY: ${{ vars.TRACE_OPACITY || '0.6' }}
          TILE_OPACITY: ${{ vars.TILE_OPACITY || '0.15' }}
          TILE_COLOR: ${{ vars.TILE_COLOR || '#7ED321' }}
          TRACE_COLOR: ${{ vars.TRACE_COLOR || '#D0021B' }}
        run: |
          echo "=========================================="
          echo "ðŸš€ KOMOOT SQUADRA MAP - SYNCHRONISATION"
          echo "=========================================="
          echo ""
          echo "Configuration:"
          echo "  User ID: ${{ secrets.KOMOOT_USER_ID }}"
          echo "  Simplify Factor: ${SIMPLIFY_FACTOR}"
          echo "  Tile Zoom: ${TILE_ZOOM}"
          echo "  Tile Color: ${TILE_COLOR}"
          echo "  Trace Color: ${TRACE_COLOR}"
          echo ""
          
          python komoot_squadra_improved.py
          
          echo ""
          echo "âœ… Synchronisation terminÃ©e"
      
      # ====================================
      # 4. VERIFICATION
      # ====================================
      
      - name: ðŸ“Š VÃ©rification des fichiers gÃ©nÃ©rÃ©s
        run: |
          echo "ðŸ” VÃ©rification des fichiers..."
          
          if [ ! -f "index.html" ]; then
            echo "âŒ ERREUR: index.html non gÃ©nÃ©rÃ©"
            exit 1
          fi
          
          # Le nom du fichier de donnÃ©es dans le nouveau script est 'komoot_data_cache.json'
          # On vÃ©rifie si l'un ou l'autre existe pour Ã©viter de casser le build
          if [ -f "komoot_data_cache.json" ]; then
             echo "âœ… Fichier de donnÃ©es trouvÃ©: komoot_data_cache.json"
             # On le renomme temporairement pour la compatibilitÃ© du dÃ©ploiement si besoin
             cp komoot_data_cache.json all_points.json
          elif [ ! -f "all_points.json" ]; then
            echo "âŒ ERREUR: Aucun fichier JSON de donnÃ©es trouvÃ©"
            exit 1
          fi
          
          echo "âœ… Fichiers vÃ©rifiÃ©s."
      
      # ====================================
      # 5. DEPLOIEMENT GITHUB PAGES
      # ====================================
      
      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          commit_message: 'ðŸ—ºï¸ Update Squadra Map [Run ${{ github.run_number }}]'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          # Inclure seulement les fichiers nÃ©cessaires
          exclude_assets: '.github,*.py,*.md,requirements.txt'
      
      # ====================================
      # 6. RESUME
      # ====================================
      
      - name: ðŸ“ CrÃ©ation du rÃ©sumÃ©
        if: always()
        run: |
          echo "# ðŸ—ºï¸ Komoot Squadra Map - Synchronisation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "index.html" ]; then
            echo "## âœ… Synchronisation rÃ©ussie" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Votre carte est disponible ici:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ **https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Ã‰chec de la synchronisation" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs ci-dessus pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
          fi
